<div id="template-committee-card" style="display:none;" class="committee parent col-xs-12 col-md-6 col-lg-4">
	<div class="committee card">
		<div class="top priori" style="position:relative;display:none;">
			<div class="default btn mov-left"><i style="font-size:20px;" class="fa fa-angle-left"></i></div>
			<div class="default btn add-left"><i style="font-size:20px;" class="fa fa-plus"></i></div>
			<div class="default btn edit"><i style="font-size:20px;" class="fa fa-pencil"></i></div>
			<div class="default btn add-right"><i style="font-size:20px;" class="fa fa-plus"></i></div>
			<div class="default btn mov-right"><i style="font-size:20px;" class="fa fa-angle-right"></i></div>
			<div class="editing btn exit"><i style="font-size:20px;" class="fa fa-times"></i></div>
			<div class="editing btn delete"><i style="font-size:20px;" class="fa fa-trash"></i></div>
		</div>
		<hr class="priori" style="display: none;"/>
		<div data-editable class="header" style="padding-bottom:5px;"></div><hr class="expanded" style="display:none;"/>
		<div data-editable class="expanded body" style="display:none;"></div>
		<!-- <div data-editable class="location" style="padding-bottom:5px;"></div> -->
		<!-- ATLAS -->
		<div data-editable class="default btn bottom"><i class="fa fa-angle-down" style="font-size:20px;"></i></div>
		<div data-editable class="editing btn bottom"><i class="fa fa-save" style="font-size:20px;"></i></div>
	</div>
</div>
<section id="committee-section">
	<div class="c-loader" style="position:fixed;left:0;top:0;width:100%;height:100vh;z-index:100;background-color:white;">
		<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;">
			<h4>LOADING COMMITTEE...</h4>
			<div class="lds-ellipsis">
				<div></div><div></div><div></div><div></div>
			</div>
		</div>
	</div>
	<div class="c-content" style="display:none;">
		<div class="container">
			<h1>Committee <span class="committee add" style="display:none;"><i class="fa fa-plus-circle"></i></span></h1>
			<div class="row committee populate"></div>
		</div>
	</div>
</section>
<script>
$("#committee-section").on('displaycontent', function() {
	$(".c-content").show();
	$(".c-loader").fadeOut(1000);
});
$("#committee-section").on('cleanup', function() {
	Lib.Pinboard.UI.Cleanup();
});
$("#committee-section").on('init', function() {
	var el_section = $("#committee-section");

	Lib.Pinboard.UI.Init({
		feed_type: 'committee',
		feed_section: el_section,
		feed_template: $("#template-committee-card"),
		ref_names: {
			load: ['header', 'body'],
			edit: ['header', 'body'],
			save: ['header', 'body']
		}
	});

	var committee_member = false;
	if(Lib.User.State.type == "success") {
		var access_level = (Lib.User.Group.State.access_level);
		if(access_level <= Lib.User.Group.EAccessLevel.COMMITTEE) {
			$(this).find('.committee.add').show();
			committee_member = true;
		}
	}
	el_section.on('generate_post', function(e, data) {
		var el_singleton = data.el_singleton;
		var el_populate = data.el_populate;
		el_populate.append(el_singleton);

		$(el_singleton).on('edit delete unedit expand deflate', function() {
			el_populate.isotope('layout');
		});
		if(!committee_member)return;



		$(el_singleton).find('.default.btn.mov-left').on('click', function() {
			var item_list = el_populate.data('isotope').filteredItems;
			if(el_singleton[0] === item_list[0].element)return;
			// find location	
			var i = 0;
			for(i=0;i<item_list.length;i++){if(el_singleton[0] === item_list[i].element)break;}
			if(i >= item_list.length)return;

			var j = i-1;
			var pi = $(item_list[i].element).attr('pinboard_position');
			var pj = $(item_list[j].element).attr('pinboard_position');
			$(item_list[i].element).attr('pinboard_position', pj);
			$(item_list[j].element).attr('pinboard_position', pi);
			$(item_list[i].element).trigger('save_position');
			$(item_list[j].element).trigger('save_position');
			el_populate.isotope('updateSortData').isotope({ sortBy: 'pinboard_position' });
		});
		$(el_singleton).find('.default.btn.mov-right').on('click', function() {
			var item_list = el_populate.data('isotope').filteredItems;
			if(el_singleton[0] === item_list[item_list.length-1].element)return;
			// find location	
			var i = 0;
			for(i=0;i<item_list.length;i++){if(el_singleton[0] === item_list[i].element)break;}
			if(i >= item_list.length)return;

			var j = i+1;
			var pi = $(item_list[i].element).attr('pinboard_position');
			var pj = $(item_list[j].element).attr('pinboard_position');
			$(item_list[i].element).attr('pinboard_position', pj);
			$(item_list[j].element).attr('pinboard_position', pi);
			$(item_list[i].element).trigger('save_position');
			$(item_list[j].element).trigger('save_position');
			el_populate.isotope('updateSortData').isotope({ sortBy: 'pinboard_position' });
		});
		$(el_singleton).find('.default.btn.add-left').on('click', function() {
			var el_populate = el_section.find('.committee.populate');
			var pinboard_position = 0;
			var item_list = el_populate.data('isotope').filteredItems;
			if(el_singleton[0] === item_list[0].element) {
				pinboard_position = parseInt(el_singleton.attr('pinboard_position'))-Lib.Pinboard.CREATE_INTERVAL;
			} else {
				// find location	
				var i = 0;
				for(i=0;i<item_list.length;i++){if(el_singleton[0] === item_list[i].element)break;}
				if(i >= item_list.length)return;
				var j = i-1;
				var pi = parseInt($(item_list[i].element).attr('pinboard_position'));
				var pj = parseInt($(item_list[j].element).attr('pinboard_position'));
				var mp = Lib.Pinboard.CREATE_POSITION(pi, pj);
				if(Math.abs(mp - pi) <= 1) {
					Lib.App.Notify({
						title: "PINBOARD SATURATION --- SEVERE ERROR!",
						content: "RECREATING THE ENTIRE AREA",
						wait: 0,
						icon: 'fa fa-times'
					});
					el_section.triggerHandler('saturation_react');
					return;
				}
				pinboard_position = mp;
			}
			
			el_section.triggerHandler('generate_dummy', {
				blk_refs: {
					'header': {"data": "<h1>Title</h1><h2>Title Sub</h2>"},
					'body': {"data": "<p>Body</p>"}
				},
				pinboard_position: pinboard_position,
				cb: function(data) {
					el_section.triggerHandler('generate_post', {
						el_populate: el_populate,
						el_singleton: this
					});
					el_populate
					.isotope('prepended', this)
					.isotope('updateSortData')
					.isotope({ sortBy: 'pinboard_position' });
					$(this).triggerHandler('edit');
				}
			});
		});
		$(el_singleton).find('.default.btn.add-right').on('click', function() {
			var el_populate = el_section.find('.committee.populate');
			var pinboard_position = 0;
			var item_list = el_populate.data('isotope').filteredItems;
			if(el_singleton[0] === item_list[item_list.length-1].element) {
				pinboard_position = parseInt(el_singleton.attr('pinboard_position'))+Lib.Pinboard.CREATE_INTERVAL;
			} else {
				// find location	
				var i = 0;
				for(i=0;i<item_list.length;i++){if(el_singleton[0] === item_list[i].element)break;}
				if(i >= item_list.length)return;
				var j = i+1;
				var pi = parseInt($(item_list[i].element).attr('pinboard_position'));
				var pj = parseInt($(item_list[j].element).attr('pinboard_position'));
				var mp = Lib.Pinboard.CREATE_POSITION(pi, pj);
				if(Math.abs(mp - pi) <= 1) {
					Lib.App.Notify({
						title: "PINBOARD SATURATION --- SEVERE ERROR!",
						content: "RECREATING THE ENTIRE AREA",
						wait: 0,
						icon: 'fa fa-times'
					});
					el_section.triggerHandler('saturation_react');
					return;
				}
				pinboard_position = mp;
			}
			
			el_section.triggerHandler('generate_dummy', {
				blk_refs: {
					'header': {"data": "<h1>Title</h1><h2>Title Sub</h2>"},
					'body': {"data": "<p>Body</p>"}
				},
				pinboard_position: pinboard_position,
				cb: function(data) {
					el_section.triggerHandler('generate_post', {
						el_populate: el_populate,
						el_singleton: this
					});
					el_populate
					.isotope('prepended', this)
					.isotope('updateSortData')
					.isotope({ sortBy: 'pinboard_position' });
					$(this).triggerHandler('edit');
				}
			});
		});
		$(el_singleton).find('.priori').show();
	});
	$(el_section).on('saturation_react', function() {
			var item_list = el_populate.data('isotope').filteredItems;
			var j = 0;
			for(var i in item_list) {
				var el = item_list[i].element;
				var blk = $(el).data('blk');
				Lib.Ajax.Singleton.Update({
					blk_id: blk.blk_id,
					metadata: {
						pinboard_position: j
					}
				});
				j += Lib.Pinboard.CREATE_INTERVAL;

			}
		});
	
	// Load Events
	Lib.Pinboard.Fetch({
		feed_type: 'committee',
		count: 10
	}, function(blks) {
		for(var i in blks) {
			var blk = blks[i];
			var pinboard_position = JSON.parse(blk.metadata).pinboard_position;
			var el_populate = el_section.find('.committee.populate');
			el_section.trigger('generate', {
				blk: blk,
				cb: function(data) {
					el_section.triggerHandler('generate_post', {
						el_populate: el_populate,
						el_singleton: this
					});
				}
			});
		}
		el_section.triggerHandler('displaycontent');
		el_section.find('.committee.populate').isotope({
			"itemSelector": ".committee.parent",
			getSortData: {
				'pinboard_position': function(el) {return parseInt($(el).attr('pinboard_position'));},
				'blk_id': function(el) {return parseInt($(el).attr('blk_id'));},
			},
			sortBy: 'pinboard_position'
		});
	});
});

$(".committee.add").on('click', function() {
	var committee_member = false;
	if(Lib.User.State.type == "success") {
		var access_level = (Lib.User.Group.State.access_level);
		if(access_level <= Lib.User.Group.EAccessLevel.COMMITTEE) {
			committee_member = true;
		}
	}

	var el_populate = $("#committee-section").find('.committee.populate');

	var pinboard_position = 0;
	var first = el_populate.children().first();
	if(first.length)
		pinboard_position = parseInt(first.attr('pinboard_position'))-Lib.Pinboard.CREATE_INTERVAL;
	

	$("#committee-section").triggerHandler('generate_dummy', {
		blk_refs: {
			'header': {"data": "<h1>Title</h1><h2>Title Sub</h2>"},
			'body': {"data": "<p>Body</p>"}
		},
		pinboard_position: pinboard_position,
		cb: function(data) {
			el_populate.append(this);
			el_populate.isotope('prepended', this);
			el_populate.isotope('layout');
			$(this).triggerHandler('edit');
			if(committee_member)
				$(this).find('.priori').show();
		}
	});
});

// TODO: merge success calls
$(window).on('user_group_success user_group_failure user_session_destroyed', function() {
	$("#committee-section").triggerHandler('init');
});
$(SKY.History).on('construct.committee', function(e, data) {
	$("#committee-section").triggerHandler('init');
});
$(SKY.History).on('deconstruct', function(e, data) {
	$("#committee-section").triggerHandler('cleanup');
	$(SKY.History).off('construct.committee');
});
</script>