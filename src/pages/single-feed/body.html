<style>
.col-centered{
    float: none;
    margin: 0 auto;
}
</style>
<div id="template-event-card" style="display:none;" class="event parent col-xs-12 col-md-6 col-centered">
	<div class="event card">
		<div style="position:relative;" class="top">
			<div data-editable class="date"></div>
			<div class="btn link"><i style="font-size:20px;" class="fa fa-link"></i></div>
			<div class="default btn edit"><i style="font-size:20px;" class="fa fa-pencil"></i></div>
			<div class="editing btn exit"><i style="font-size:20px;" class="fa fa-times"></i></div>
			<div class="editing btn delete"><i style="font-size:20px;" class="fa fa-trash"></i></div>
		</div><hr/>
		<div data-editable class="header" style="padding:0 5px 5px 5px;"></div><hr/>
		<div data-editable class="expanded body" style="display:none;"></div><hr class="expanded" style="display:none;"/>
		<div data-editable class="location" style="padding:0 5px 5px 5px;"></div>
		<!-- ATLAS -->
		<div data-editable class="default btn bottom"><i class="fa fa-angle-down" style="font-size:20px;"></i></div>
		<div data-editable class="editing btn bottom"><i class="fa fa-save" style="font-size:20px;"></i></div>
	</div>
</div>
<div id="template-news-card" style="display:none;" class="news parent col-xs-12 col-centered">
	<div class="news card">
		<div style="position:relative;">
			<div class="date-edit"><h2 class="date"></h2></div>
			<div class="btn link"><i style="font-size:20px;" class="fa fa-link"></i></div>
			<div class="default btn edit"><i style="font-size:20px;" class="fa fa-pencil"></i></div>
			<div class="editing btn exit"><i style="font-size:20px;" class="fa fa-times"></i></div>
			<div class="editing btn delete"><i style="font-size:20px;" class="fa fa-trash"></i></div>
		</div><hr/>
		<div data-editable class="header" style="padding-bottom:5px;"></div><hr class="expanded"/>
		<div data-editable class="expanded body" style="display:none;"></div><hr class="expanded"/>
		<!-- <div data-editable class="location" style="padding-bottom:5px;"></div> -->
		<!-- ATLAS -->
		<div data-editable class="default btn bottom"><i class="fa fa-angle-down" style="font-size:20px;"></i></div>
		<div data-editable class="editing btn bottom"><i class="fa fa-save" style="font-size:20px;"></i></div>
	</div>
</div>
<section id="feed-section">
	<div class="container">
		<div class="row populate">
			
		</div>
	</div>
</section>
<script>
var el_section = $("#feed-section");
el_section.on('init', function() {
	var el_populate = el_section.find(".populate");

	var usp = new URLSearchParams(document.location.search);
	var blk_id = usp.get('blk_id');
	if(!blk_id)return;
	
	SKY.Ajax.Blk.RefsFetch({
		blk_ids: [blk_id]
	}).done(function(json) {
		var feed_out = [];
		var feeds = JSON.parse(json['blks']);
		if(feeds.length < 1)return;
		var feed = feeds[0];
		feed = feed || {
			blk_id: i,
			hash: '',
			metadata: '',
			blk_refs: {}
		};
		var md = JSON.parse(feed.metadata);
		// localStorage.setItem("blk-"+feed.blk_id, LZString.compress(JSON.stringify(feed)));
		// localStorage.setItem("blk-"+feed.blk_id+"-hash", feed.hash);
		feed['feed_date'] = md.feed_date;
		switch(md.handler) {
		case 'events':
			Lib.Feed.UI.Init({
				feed_type: 'events',
				feed_section: el_section,
				feed_template: $("#template-event-card"),
				ref_names: {
					load: ['header', 'body', 'location'],
					edit: ['header', 'body', 'location', 'date'],
					save: ['header', 'body', 'location']
				}
			});
			break;
		case 'news':
			Lib.Feed.UI.Init({
				feed_type: 'news',
				feed_section: el_section,
				feed_template: $("#template-news-card"),
				ref_names: {
					load: ['header', 'body'],
					edit: ['header', 'body', 'date'],
					save: ['header', 'body']
				}
			});
			break;
		default:
			return;
		}
		el_section.triggerHandler('generate', {
			blk: feed,
			cb: function() {
				$(this).triggerHandler('expand');
				el_populate.append(this);
			}
		});
	});
});
el_section.on('cleanup', function() {
	Lib.Feed.UI.Cleanup();
});


$(window).on('user_group_success user_group_failure user_session_destroyed', function() {
	el_section.triggerHandler('init');
});
$(SKY.History).on('construct.events', function(e, data) {
	el_section.triggerHandler('init');
});
$(SKY.History).on('deconstruct', function(e, data) {
	el_section.triggerHandler('cleanup');
	$(SKY.History).off('construct.events');
});
</script>